{% extends "base.html" %}

{% block title %}Log a Meal - Steady{% endblock %}

{% block body %}
    <div class="container py-4">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold mb-3">Log Your Meal</h1>
            <p class="lead mb-4">Record what you've eaten to track your nutrition.</p>
        </div>

        <!-- select data and meal type -->
        <div class="card shadow-sm border-0 rounded text-dark" style="opacity: 1; background-color: white;">
            <div class="card-body">
                <h2 class="card-title h4 mb-4 border-bottom pb-2">Meal Details</h2>
                <div class="row g-3 mb-4">
                    <!-- date -->
                    <div class="col-md-6">
                        <label for="log-date" class="form-label fw-semibold">Date</label>
                        <input type="date" id="log-date" value="{{ today_str }}" class="form-control">
                    </div>

                    <!-- meal type -->
                    <div class="col-md-6">
                        <label for="meal-type" class="form-label fw-semibold">Meal Type to Search or Log for</label>
                        <select id="meal-type" class="form-select">
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                </div>
                <button id="view-logged-meals-bttn" class="btn btn-success w-100">
                    View/Refresh Logged Meals for Selected Date
                </button>
            </div>

            <!-- logged meals for selected date -->
            <div id="logged-meals-display" class="card shadow-sm border-0 rounded mb-5" style="min-height: 100px;">
                <div class="card-body text-dark">
                    <h2 class="card-title h4 mb-4 border-bottom pb-2">Meals Logged for <span id="current-logged-date">{{ today_str }}</span>:</h2>
                    <div id="logged-meals-list">
                        <p class="text-center">Select a date and click "View/Refresh" to see logged meals.</p>
                        <!-- will be added using javascript  -->
                    </div>
                </div>
            </div>

            <!-- recipe search section (for logging) -->
            <div class="card shadow-sm border-0 rounded">
                <div class="card-body d-flex flex-column text-dark">
                    <h2 class="card-title h4 mb-4 border-bottom pb-2">Search Recipes to Log:</h2>
                    <div class="input-group mb-3">
                        <label for="recipe-search-input-log" class="visually-hidden">Search for recipes</label>
                        <input type="text" id="recipe-search-input-log" placeholder="Search for recipes" class="form-control">
                        <button id="search-recipes-bttn-log" class="btn btn-success">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                    

                    <div id="search-results-log" class="row row-cols-1 row-cols-sm-2 g-3 flex-grow-1">
                        <p class="text-center col-12">Start searching to find recipes to log.</p>
                        <!-- results added using javascript -->
                    </div>
                </div>
            </div>
        </div> 
    </div>
{% endblock %}

{% block after_body %}
<script>
    // date and meal type input 
    const logDateInput = document.querySelector("#log-date");
    const mealTypeSelect = document.querySelector("#meal-type");

    // button and div to view logged meals 
    const viewLoggedMealsButtn = document.querySelector("#view-logged-meals-bttn");
    const loggedMealsListDiv = document.querySelector("#logged-meals-list");
    const currentLoggedDateSpan = document.querySelector("#current-logged-date");
    
    // button and div search for recipes to log
    const searchInputLog = document.querySelector("#recipe-search-input-log");
    const searchBttnLog = document.querySelector("#search-recipes-bttn-log");
    const searchResultsLogDiv = document.querySelector("#search-results-log");
    
    // add event listener to view logged meals button 
    viewLoggedMealsButtn.addEventListener("click", (evt) => {
        const selectedDate = logDateInput.value;

        currentLoggedDateSpan.textContent = new Date(selectedDate).toUTCString().slice(0,-13);

        loggedMealsListDiv.innerHTML = "<div class='spinner-border text-success' role='status'></div><p class='text-center visually-hidden'>loading logged meals...</p>";

        console.log(selectedDate);
        console.log(currentLoggedDateSpan);

        fetch(`/api/meal-log/get?date=${selectedDate}`)
            .then((response) => response.json())
            .then((responseJson) => {

                loggedMealsListDiv.innerHTML = "";

                if (responseJson.length === 0) {
                    loggedMealsListDiv.innerHTML = "<p class='text-danger text-center'>No meals logged for this date.</p>";
                } else {
                    // group meals by meal type 
                    const groupedMeals = {};

                    for (const meal_log of responseJson) {
                        const mealType = meal_log.meal_type;

                        if (!groupedMeals[mealType]) {
                            groupedMeals[mealType] = [];
                        }
                        // add current meal_log entry to array for its meal type
                        groupedMeals[mealType].push(meal_log);
                    }

                    // display meals
                    const mealTypesOrder = ["breakfast", "lunch", "dinner", "snack"];

                    for (const type of mealTypesOrder) {
                        let mealsOfType; 

                        if (groupedMeals[type]) {
                            // list of meals for this particular meal type
                            mealsOfType = groupedMeals[type]
                        } else {
                            // no meals for this meal type 
                            mealsOfType = [];
                        }

                        if (mealsOfType.length > 0) {

                            const mealGroupDiv = document.createElement("div");

                            let listOfMealLogsHtml = "";
                            for (const loggedMeal of mealsOfType) { // loop through each meal log entry
                                listOfMealLogsHtml += `
                                    <li class='d-flex align-items-center justify-content-between mb-1'>
                                        ${loggedMeal.recipe_title} (Servings: ${loggedMeal.serving_size})

                                        <button data-meal-log-id="${loggedMeal.meal_log_id}" data-recipe-id="${loggedMeal.recipe_id}" data-meal-type="${loggedMeal.meal_type}" class="remove-from-log-buttn btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash-fill"></i>
                                        </button> 
                                    </li>
                                `;
                            }

                            mealGroupDiv.innerHTML = `
                                <h4 class='fw-bold text-capitalize mb-2'>${type}</h4>
                                <ul class='list-unstyled mb-0 ms-3'>
                                    ${listOfMealLogsHtml}
                                </ul>
                            `;

                            loggedMealsListDiv.appendChild(mealGroupDiv);
                        }
                    }
                }
                removeRecipeButtons = document.querySelectorAll(".remove-from-log-buttn");

                for (const button of removeRecipeButtons) {
                    button.addEventListener("click", (evt) => {
                        const mealLogId = button.dataset.mealLogId
                        const recipeId = button.dataset.recipeId
                        const mealType = button.dataset.mealType

                        fetch("/api/meal-log-remove", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                meal_log_id: mealLogId,
                                recipe_id: recipeId,
                                meal_type: mealType
                            }),
                        })
                        .then((response) => response.json())
                        .then((responseJson) => {
                            alert((responseJson.message));
                            window.location.reload();
                        });
                    });
                }
            });
    });

    // add event listener to recipe search button - AJAX display recipes a user can add to meal log
    searchBttnLog.addEventListener("click", (evt) => {

        const query = searchInputLog.value.trim();

        if (!query) {
            searchResultsLogDiv.innerHTML = "<p class='text-center col-span-full'>Enter a search term to view recipes</p>";
            
            return;
        }

        searchResultsLogDiv.innerHTML = "<div class='spinner-border text-success' role='status'></div><p class='text-center visually-hidden'>Searching...</p>";

        fetch(`/api/recipes/search?query=${query}`)
        .then((response) => response.json())
        .then((responseJson) => {

            searchResultsLogDiv.innerHTML = "";

            if (responseJson.length === 0 || !responseJson.length) {
                searchResultsLogDiv.innerHTML = "<p class='text-center'>No recipes found matching your criteria.</p>";
            } else {
                for (const recipe of responseJson) {
                    const recipeCard = document.createElement("div");

                    recipeCard.className = 'col';

                    recipeCard.innerHTML = `
                    <div class='card h-100 shadow-sm border-0 rounded'>
                        <div class='card-body'>
                            <h4 class="card-title h5 mb-2">${recipe.title}</h4>
                            <p class='card-text mb-1'>Servings: ${recipe.servings}</p>
                            <a href='${recipe.url}'' target='_blank' rel='noopener noreferrer' class='card-link mb-3 text-success'>
                            <button data-recipe-id='${recipe.id}' data-recipe-title='${recipe.title}' data-recipe-servings='${recipe.servings}' class="log-recipe-bttn btn btn-sm btn-success mt-auto">
                                Log This Recipe
                            </button>
                        </div>
                    </div>
                    `;
                    searchResultsLogDiv.appendChild(recipeCard);
                };

                // event listeners for "Log this recipe" button 
                const logRecipeButtns = document.querySelectorAll(".log-recipe-bttn")

                for (const button of logRecipeButtns) {
                    button.addEventListener("click", (evt) => {
                        const recipeId = button.dataset.recipeId;
                        const recipeTitle = button.dataset.recipeTitle;
                        const recipeServings = parseFloat(button.dataset.recipeServings);

                        // get date and meal type from user
                        const logDate = logDateInput.value;
                        const mealType = mealTypeSelect.value;

                        let servingsToLog = parseFloat(prompt(`How many servings of "${recipeTitle}" did you eat? (original servings)`));
                        if (isNaN(servingsToLog) || servingsToLog < 0) {
                            alert("enter valid positive number.")
                            return;
                        }

                        fetch("/api/meal-log/add", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                "log_date": logDate,
                                "meal_type": mealType,
                                "recipe_id": recipeId,
                                "serving_size": servingsToLog
                            }),
                        })
                        .then((response) => response.json())
                        .then((responseJson) => {
                            alert(`${responseJson.message}`);
                        });

                    });
                };
            }
        });
    });

    // event listeners for "Remove recipe" - remove from meal log


    // 

</script>
{% endblock %}