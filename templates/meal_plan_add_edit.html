{% extends 'base.html' %}



{% block title %}Plan for {{ target_date.strftime("%A, %B, %d, %Y") }} - Steady{% endblock %}

{% block body %}
    <div>
        <h1>
            Plan Meals for {{ target_date.strftime("%A, %B, %d, %Y") }}
        </h1>
        <p>Add or remove recipes for your meal plan.</p>
        <form action="/meal-plan/edit/{{ target_date.strftime('%Y-%m-%d') }}" method="POST">
            <label for="date-string">Choose another day:</label>
            <input type="date" name="date-string" id="date-string">
            <button type="submit">Change Date</button>
        </form>
    </div>
    
    <!-- current planned meals for this day -->
    <div>
        <h2>
            Currently Planned:
        </h2>
        {% set meal_types = ['breakfast', 'lunch', 'dinner', 'snack'] %}
        {% if current_planned_meals_for_day %}
            {% for meal_type in meal_types %}
                <div>
                    <h3>{{ meal_type }}:</h3>
                    {% if current_planned_meals_for_day[meal_type] %}
                    <ul>
                        {% for meal_plan_recipe in current_planned_meals_for_day[meal_type] %}
                        <li>
                            {{ meal_plan_recipe.recipe.title }}
                            
                            <button class="remove-from-plan-buttn" id="remove-recipe" data-recipe-id="{{ meal_plan_recipe.recipe_id }}" data-meal-type="{{ meal_plan_recipe.meal_type }}">
                                Remove recipe
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>No {{ meal_type }} planned.</p>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>No meals planned for this day yet.</p>
        {% endif %}
    </div>

    <!-- recipe search section -->
    <div>
        <h2>
            Search & Add Recipes:
        </h2>
        <div>
            <label for="recipe-search-input">Recipe Search</label>
            <input type="text" name="recipe-search" id="recipe-search-input" placeholder="Search for recipes (ex. 'chicken soup')">
            <button id="recipe-search-button">
                Search
            </button>
        </div>

        <!-- basic filters for search -->
        <div>
            <span>Filters:</span>
            <span>
                <label for="filter-likes">My Liked Ingredients</label>
                <input type="checkbox" name="filter-likes" id="filter-likes">
            </span>
        </div>

        <!-- recipe search results -->
        <div id="search-results">
            <!-- search results will be inserted here by javascript (AJAX -->
            <p>Start searching to find recipes üçΩÔ∏è</p>
        </div>
    </div>
{% endblock %}

{% block after_body %}
    <script>
        // get target date string 
        const targetDate = "{{ target_date.strftime('%Y-%m-%d') }}";
        
        // grab DOM elements 
        const recipeSearchInput = document.querySelector("#recipe-search-input");
        const recipeSearchBttn = document.querySelector("#recipe-search-button");
        const recipeSearchResultDiv = document.querySelector("#search-results");
        const filterLikesCheckbox = document.querySelector("#filter-likes");


        recipeSearchBttn.addEventListener("click", (evt) => {
            const queryRecipeSearch = recipeSearchInput.value.trim();
            if (!queryRecipeSearch) {
                recipeSearchResultDiv.textContent = "Please enter search term."
                return;
            };

            // check if "likes" filter is active
            const likesFilter = filterLikesCheckbox.checked;

            // show a loading message to user
            recipeSearchResultDiv.innerHTML = "<p>Searching...</p>";

            const params = new URLSearchParams({
                query: queryRecipeSearch,
                likes: likesFilter
            }).toString();

            fetch(`/api/recipes/search?${params}`)
                .then((response) => response.json())
                .then((responseJson) => {

                    // console.log(responseJson)

                    recipeSearchResultDiv.innerHTML = "";

                    if (responseJson.message) {
                        recipeSearchResultDiv.innerHTML = `<p>${responseJson.message}</p>`;
                        return;
                    }

                    if (responseJson.length === 0) {
                        recipeSearchResultDiv.innerHTML = "<p>No recipes found matching criteria.</p>";
                    } else {
                        for (const recipe of responseJson) {
                            const recipeCard = document.createElement("div");
                            recipeCard.innerHTML = `
                            <h4>${recipe.title}</h4>
                            <p>Servings: ${recipe.servings}</p>
                            <a href="${recipe.url}">View Recipe</a>
                            <button class="add-to-plan-buttn" data-recipe-id="${recipe.id}" data-recipe-title="${recipe.title}" data-recipe-servings="${recipe.servings}">
                                Add to Plan
                            </button>
                            `;
                            recipeSearchResultDiv.appendChild(recipeCard)

                        };

                        // event listeners for "Add to Plan" buttons on recipes
                        const addToMealPlanButtons = document.querySelectorAll(".add-to-plan-buttn")

                        for (const button of addToMealPlanButtons) {
                            button.addEventListener("click", (evt) => {
                                const recipeId = button.dataset.recipeId;
                                const recipeTitle = button.dataset.recipeTitle;
                                const recipeServings = parseFloat(button.dataset.recipeServings);

                                const mealType = prompt(`Add "${recipeTitle}" to which meal type (breakfast, lunch, dinner, snack)?`).toLowerCase();

                                if (!mealType) {
                                    return;
                                }

                                const servingsMealPlanRecipe = parseFloat(prompt(`How many servings of "${recipeTitle}"? (Original: ${recipeServings})`));

                                
                                // send AJAX POST request to add recipe to meal plan
                                fetch("/api/meal-plan/add", {
                                    method: "POST",
                                    headers: {
                                        "content-type": "application/json", // tell flask sending json 
                                    },
                                    body: JSON.stringify({
                                        meal_plan_date: targetDate,
                                        recipe_id: recipeId,
                                        meal_type: mealType,
                                        serving_size: servingsMealPlanRecipe,
                                    }),
                                })
                                .then((response) => response.json())
                                .then((responseJson) => {
                                    if (responseJson.status === "success") {
                                        alert(responseJson.message);
                                        window.location.reload(); // simple reload to update currently planned section
                                    } else {
                                        alert(`Error: ${responseJson.message}`);
                                    }
                                });
                                

                            });
                        };
                    };
                });
        });
        
        // event listeners for "Remove recipe" buttons on recipes
        RemoveRecipeButtons = document.querySelectorAll(".remove-from-plan-buttn");

        for (const button of RemoveRecipeButtons) {
            button.addEventListener("click", (evt) => {
                const recipeId = button.dataset.recipeId;
                const mealType = button.dataset.mealType;

                fetch("/api/meal-plan/remove", {
                    method:"POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        meal_plan_date: targetDate, // the date for this page
                        recipe_id: recipeId,
                        meal_type: mealType
                    }),

                })
                .then((response) => response.json())
                .then((responseJson) => {
                    alert(responseJson.message);
                    window.location.reload();
                });

            });
        }

    </script>
{% endblock %}